# docker-compose.yml

name: ${COMPOSE_PROJECT_NAME:-rocketgraph}

services:
  frontend:
    image: docker.io/rocketgraph/mission-control-frontend:${MC_VERSION:-latest}
    ports:
      - "${MC_PORT:-80}:80"
      - "${MC_SSL_PORT:-443}:443"
    networks:
      - external-network
    volumes:
      - ${MC_SSL_PUBLIC_CERT:-~/.rocketgraph/.fallback_mount/certs/xgt-public.pem}:/etc/ssl/certs/td.pem:ro,Z
      - ${MC_SSL_PRIVATE_KEY:-~/.rocketgraph/.fallback_mount/certs/xgt-private.pem}:/etc/ssl/private/td.pem:ro,Z
      - ${MC_SSL_CERT_CHAIN:-~/.rocketgraph/.fallback_mount/certs/xgt-chain.pem}:/etc/ssl/certs/ca-chain.pem:ro,Z
    depends_on:
      - backend
    restart: on-failure

  backend:
    image: docker.io/rocketgraph/mission-control-backend:${MC_VERSION:-latest}
    environment:
      MC_MONGO_URI: mongodb://mongodb:27017
      MC_DEFAULT_XGT_HOST: ${MC_DEFAULT_XGT_HOST:-}
      MC_DEFAULT_XGT_PORT: ${MC_DEFAULT_XGT_PORT:-}
      MC_SESSION_TTL: ${MC_SESSION_TTL:-}
      MC_SSL_PUBLIC_CERT: ${MC_SSL_PUBLIC_CERT:-}
      MC_SSL_PRIVATE_KEY: ${MC_SSL_PRIVATE_KEY:-}
      MC_SSL_PROXY_PUBLIC_CERT: ${MC_SSL_PROXY_PUBLIC_CERT:-}
      MC_SSL_PROXY_PRIVATE_KEY: ${MC_SSL_PROXY_PRIVATE_KEY:-}
      XGT_SERVER_CN: ${XGT_SERVER_CN:-}
      XGT_AUTH_TYPES: ${XGT_AUTH_TYPES:-}
      LD_LIBRARY_PATH: "/odbc:${MC_ODBC_LIBRARY_PATH-}"
    networks:
      - database-network
      - external-network
    volumes:
      - ${XGT_SSL_SERVER_CERT:-~/.rocketgraph/.fallback_mount/certs/xgt-server.pem}:/etc/ssl/certs/xgt-server.pem:ro,Z
      - ${MC_SSL_PROXY_PUBLIC_CERT:-~/.rocketgraph/.fallback_mount/certs/proxy-client-cert.pem}:/etc/ssl/certs/proxy-client-cert.pem:ro,Z
      - ${MC_SSL_PROXY_PRIVATE_KEY:-~/.rocketgraph/.fallback_mount/certs/proxy-client-key.pem}:/etc/ssl/private/proxy-client-key.pem:ro,Z
      - mongodb-data:/app/data
      - ${MC_ODBC_PATH:-~/.rocketgraph/.fallback_mount/odbc}:/odbc:Z
      - ${MC_IBM_IACCESS_PATH:-~/.rocketgraph/.fallback_mount/iaccess}:/opt/ibm/iaccess:Z
    depends_on:
      - mongodb

  xgt:
    image: docker.io/rocketgraph/xgt:${XGT_VERSION:-latest}
    ports:
      - "${XGT_PORT:-4367}:4367"
    volumes:
      - ${XGT_CONF_PATH:-~/.rocketgraph/conf}:/conf:Z
      - ${XGT_DATA_PATH:-~/.rocketgraph/data}:/data:Z
      - ${XGT_LOG_PATH:-~/.rocketgraph/log}:/log:Z
      - ${XGT_LICENSE_FILE:-~/.rocketgraph/.fallback_mount/license/xgtd.lic}:/license/xgtd.lic:Z
    networks:
      - external-network

  mongodb:
    image: ${MC_MONGODB_IMAGE:-docker.io/library/mongo:latest}
    restart: always
    networks:
      - database-network
    volumes:
      - mongodb-data:/data/db

volumes:
  mongodb-data:

networks:
  database-network:
    internal: true
  external-network:
